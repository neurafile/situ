# Gadget VM - Rust Implementation

Rust implementation of the Gadget VM that compiles to WASM.

## Prerequisites

- Rust toolchain (install via [rustup](https://rustup.rs/))
- Java (required for ANTLR parser generation - ANTLR's code generator is Java-based)
- Make

**Note:** Even though ANTLR has Python tools, the code generator itself requires Java. To install Java on macOS:
```bash
brew install openjdk
```

## Setup

1. Install the WASM target:
```bash
rustup target add wasm32-unknown-unknown
```

2. Install wasm-bindgen-cli:
```bash
cargo install wasm-bindgen-cli
```

## Building

### Generate Parser from Grammar

```bash
make parser
```

This will:
- Check that Java is installed and available
- Download ANTLR JAR file with Rust support from [antlr4rust](https://github.com/rrevenantt/antlr4rust) if not present
- Generate Rust parser code from `../grammar/GadgetLanguage.g4`
- Output to `src/parser/` (generated code, do not modify)

**Note:** Standard ANTLR doesn't support Rust code generation. This project uses the Rust-compatible version from [rrevenantt/antlr4rust](https://github.com/rrevenantt/antlr4rust).

### Compile to WASM

```bash
make wasm
```

Or use the build script directly:
```bash
./build.sh
```

This will:
- Compile Rust code to WASM
- Generate JavaScript bindings using wasm-bindgen
- Output WASM and bindings to `../js-bindings/wasm/`

## Project Structure

```
rust-vm/
├── Cargo.toml          # Rust project configuration
├── Makefile            # Build automation
├── build.sh            # WASM build script
├── src/
│   ├── lib.rs          # Main library (WASM exports)
│   └── vm.rs           # VM implementation
└── src/parser/         # Generated parser code (from ANTLR)
```

## Development

The parser code in `src/parser/` is generated by ANTLR and should not be modified directly. To update the parser:

1. Edit `../grammar/GadgetLanguage.g4`
2. Run `make parser` to regenerate

## Testing

```bash
cargo test
```

## Cleaning

To clean generated files:
```bash
make clean
```

To also remove the ANTLR JAR file:
```bash
make clean-all
```
